{% extends 'base.html' %}
{% block meta %}
<title>Daftar Item</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="container mx-auto px-4 py-12 mt-16 max-w-7xl">
    <h1 class="text-4xl font-bold text-center mb-10 text-indigo-600">Daftar Item</h1>
    
    <div class="mb-6">
        <a href="{% url 'main:create_item' %}" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
            Tambah Item Barang Baru
        </a>
    </div>

    {% if items %}
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="item-list">
        {% for item in items %}
        <div class="relative bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 ease-in-out overflow-hidden" id="item-{{ item.pk }}">
            <div class="p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
              <h3 class="font-bold text-xl">{{ item.name }}</h3>
              <p>{{ item.description }}</p>
            </div>
            <div class="p-4 bg-gray-100">
              <p class="font-semibold text-lg">Harga: {{ item.price }}</p>
              <div class="flex justify-between items-center mt-4">
                <button onclick="showEditModal('{{ item.pk }}', '{{ item.name }}', '{{ item.description }}', '{{ item.price }}', '{{ item.stock }}', '{{ item.category }}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                  Edit
                </button>
                <button onclick="deleteItem('{{ item.pk }}')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">
                  Hapus
                </button>
              </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-gray-600">Tidak ada item yang ditambahkan.</p>
    {% endif %}
</div>

<!-- Modal for Edit -->
<div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-y-auto">
    <div class="relative bg-white rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0">
        <!-- Modal header -->
        <div class="flex items-center justify-between p-4 border-b rounded-t">
            <h3 class="text-xl font-semibold text-gray-900">
                Edit Item
            </h3>
            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="closeEditModal()">
                <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="sr-only">Close modal</span>
            </button>
        </div>

        <!-- Modal body -->
        <div class="px-6 py-4 space-y-6">
            <form id="editItemForm">
                {% csrf_token %}
                <div class="flex flex-col mb-4">
                    <label for="edit-name" class="font-semibold text-indigo-700">Name</label>
                    <input type="text" id="edit-name" name="name" class="p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex flex-col mb-4">
                    <label for="edit-description" class="font-semibold text-indigo-700">Description</label>
                    <textarea id="edit-description" name="description" class="p-3 border border-gray-300 rounded-lg" required></textarea>
                </div>
                <div class="flex flex-col mb-4">
                    <label for="edit-price" class="font-semibold text-indigo-700">Price</label>
                    <input type="number" id="edit-price" name="price" class="p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex flex-col mb-4">
                    <label for="edit-stock" class="font-semibold text-indigo-700">Stock</label>
                    <input type="number" id="edit-stock" name="stock" class="p-3 border border-gray-300 rounded-lg" required>
                </div>
                <input type="hidden" id="edit-item-id">
                <button type="button" onclick="submitEdit()" class="bg-indigo-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-indigo-700 transition duration-300 ease-in-out w-full">
                    Save Changes
                </button>
            </form>
        </div>
    </div>
</div>

<script>
  // Function to show the edit modal with pre-filled data
  function showEditModal(itemId, name, description, price, stock, category) {
      document.getElementById('edit-name').value = name;
      document.getElementById('edit-description').value = description;
      document.getElementById('edit-price').value = price;
      document.getElementById('edit-stock').value = stock;
      document.getElementById('edit-item-id').value = itemId;
  
      // Show the modal
      document.getElementById('editModal').style.display = 'flex';
  }
  
  // Function to close the edit modal
  function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
  }
  
  // Function to submit the edited item via AJAX
  function submitEdit() {
      const itemId = document.getElementById('edit-item-id').value;
      const name = document.getElementById('edit-name').value;
      const description = document.getElementById('edit-description').value;
      const price = document.getElementById('edit-price').value;
      const stock = document.getElementById('edit-stock').value;
  
      fetch(`/edit-item/${itemId}/`, {
          method: 'POST',
          headers: {
              'X-CSRFToken': getCsrfToken(),
              'Content-Type': 'application/json',
              'x-requested-with': 'XMLHttpRequest'
          },
          body: JSON.stringify({
              name: name,
              description: description,
              price: price,
              stock: stock
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.status === 'success') {
              alert('Item successfully updated!');
              // Update the item in the list without reloading
              updateItemInList(itemId, name, description, price, stock);
              closeEditModal();
          } else {
              alert('Error updating item: ' + data.message);
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('Failed to update item.');
      });
  }
  
  // Update the edited item in the list without reloading the page
  function updateItemInList(itemId, name, description, price, stock) {
      const itemCard = document.querySelector(`#item-${itemId}`);
      itemCard.querySelector('h3').textContent = name;
      itemCard.querySelector('p').textContent = description;
      itemCard.querySelector('.price').textContent = `Harga: ${price}`;
      itemCard.querySelector('.stock').textContent = `Stock: ${stock}`;
  }
  
  // Function to delete the item via AJAX
  function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item?')) {
        fetch(`/delete-item/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),  // Pastikan CSRF token diambil dengan benar
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Item successfully deleted!');
                removeItemFromList(itemId); // Fungsi untuk hapus dari list
            } else {
                alert('Error deleting item: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete item.');
        });
    }
}

function removeItemFromList(itemId) {
    const itemCard = document.querySelector(`#item-${itemId}`);
    if (itemCard) {
        itemCard.remove();
    }
}

function getCsrfToken() {
    return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === 'csrftoken' ? decodeURIComponent(parts[1]) : r;
    }, '');
}

  
  // Remove the deleted item from the list without reloading the page
  function removeItemFromList(itemId) {
      const itemCard = document.querySelector(`#item-${itemId}`);
      itemCard.remove();
  }
  </script>
  
{% endblock content %}
